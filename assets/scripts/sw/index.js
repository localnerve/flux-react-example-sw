/***
 * Copyright (c) 2015 Alex Grant (@localnerve), LocalNerve LLC
 * Copyrights licensed under the BSD License. See the accompanying LICENSE file for terms.
 *
 * Entry point for the service worker.
 * The precache and data modules are generated by the build.
 */
/* global Request */
'use strict';

// For now, this only works in dev builds, sw-toolbox issue #31
var toolbox = require('sw-toolbox');
var data = require('./data');

toolbox.options.cacheName = data.cacheId + '-' + toolbox.options.cacheName;
toolbox.options.debug = data.debug;

// Setup non-project static asset precaching (cdn requests)
toolbox.precache(data.assets.map(function (asset) {
  return new Request(asset, {
    mode: 'no-cors'
  });
}));

// Setup the in-project static asset precaching
require('./precache');

// TODO:
// Is this even necessary?
// Handle the api gets
data.api_gets.forEach(function (path) {
  toolbox.router.get(path+'*', toolbox.networkFirst, { debug: data.debug });
});

// TODO:
// Handle the dynamic routes
// Since these are dynamic, and all routes are dynamic:
//   1. dont need to get from built 'data'
//   2. just catch /(:route)? since all are the dynamic routes, whatever they are
//   3. must be on this origin
//   3. they all have the same network strategy
toolbox.router.get('/(.*)', toolbox.networkFirst, { debug: data.debug });

// TODO:
// Handle the background requests, try for prefetch
// Need no-cors requests
// Data needs:
// 1. full urls
// 2. other background images to replace for prefetch
//   a. the background store does this perfectly
// 3. prefetch only if first not in cache
toolbox.router.get('*', toolbox.networkFirst, {
  debug: data.debug,
  origin: 'lorempixel.com'
});

// TODO:
// Handle the post request?
// What should it do? retry in the background?
